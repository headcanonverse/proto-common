syntax = "proto3";

package events;

option go_package = "github.com/headcanonverse/proto-common/events;events";

import "google/protobuf/timestamp.proto";

// ToggleStatus описывает двоичные события (добавлен/удален, подписался/отписался и т.д.).
enum ToggleStatus {
  TOGGLE_STATUS_UNSPECIFIED = 0;
  TOGGLE_STATUS_ENABLED = 1;
  TOGGLE_STATUS_DISABLED = 2;
}

// ReadingStatus фиксирует состояние чтения книги.
enum ReadingStatus {
  READING_STATUS_UNSPECIFIED = 0;
  READING_STATUS_READING = 1;
  READING_STATUS_PAUSED = 2;
  READING_STATUS_FINISHED = 3;
}

// BookFavoritedEvent публикуется при добавлении/удалении книги из избранного.
message BookFavoritedEvent {
  string event_id = 1;
  string user_id = 2;
  string book_id = 3;
  ToggleStatus status = 4;
  google.protobuf.Timestamp occurred_at = 5;
  string source = 6; // канал, из которого пришло событие (ios/web/...).
}

// AuthorFollowedEvent публикуется при подписке на автора или отписке от него.
message AuthorFollowedEvent {
  string event_id = 1;
  string follower_id = 2;
  string author_id = 3;
  ToggleStatus status = 4;
  google.protobuf.Timestamp occurred_at = 5;
  string source = 6;
}

// ReadingProgressUpdatedEvent описывает изменение прогресса чтения.
message ReadingProgressUpdatedEvent {
  string event_id = 1;
  string user_id = 2;
  string book_id = 3;
  int32 part = 4;
  double progress_percent = 5;
  ReadingStatus status = 6;
  google.protobuf.Timestamp occurred_at = 7;
  string source = 8;
}

// BookOpenedEvent фиксирует факт открытия книги пользователем (для "недавних").
message BookOpenedEvent {
  string event_id = 1;
  string user_id = 2;
  string book_id = 3;
  int32 part = 4;
  string source = 5;
  google.protobuf.Timestamp occurred_at = 6;
}

// BookFinishedEvent публикуется, когда пользователь завершил книгу.
message BookFinishedEvent {
  string event_id = 1;
  string user_id = 2;
  string book_id = 3;
  int32 last_part = 4;          // на какой части завершили (для сериалов).
  double progress_percent = 5;  // обычно 100, но оставили поле для гибкости.
  google.protobuf.Timestamp finished_at = 6;
  string source = 7;
}

// ChapterReleasedEvent публикуется book-service при выходе новой главы/части.
message ChapterReleasedEvent {
  string event_id = 1;
  string book_id = 2;
  string chapter_id = 3;
  int32 chapter_number = 4;
  string title = 5;
  google.protobuf.Timestamp released_at = 6;
}

// BookReleasedEvent публикуется book-service при выпуске новой книги.
message BookReleasedEvent {
  string event_id = 1;
  string book_id = 2;
  string author_id = 3;
  string title = 4;
  google.protobuf.Timestamp released_at = 5;
  repeated string labels = 6;
}

// BookMetaInfoUpdatedEvent публикуется при обновлении мета-информации книги.
message BookMetaInfoUpdatedEvent {
  string event_id = 1;
  string book_id = 2;
  string meta_info_id = 3;
  string title = 4;
  string synopsis = 5;
  repeated string labels = 6;
  google.protobuf.Timestamp created_at = 7;
  google.protobuf.Timestamp updated_at = 8;
  google.protobuf.Timestamp deleted_at = 9;
  double average_rating = 10;
  int32 parts_count = 11;
  int32 reviews_count = 12;
}

// PreferenceSelection describes a chosen label/type pair.
message PreferenceSelection {
  string label_name = 1;
  string label_type = 2;
}

// UserPreferencesUpdatedEvent is emitted when a user updates their explicit preferences.
message UserPreferencesUpdatedEvent {
  string event_id = 1;
  string user_id = 2;
  repeated PreferenceSelection preferences = 3;
  google.protobuf.Timestamp occurred_at = 4;
}
