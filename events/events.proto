syntax = "proto3";

package events;

option go_package = "github.com/headcanonverse/proto-common/events;events";

import "google/protobuf/timestamp.proto";

// ToggleStatus описывает двоичные события (добавлен/удален, подписался/отписался и т.д.).
enum ToggleStatus {
  TOGGLE_STATUS_UNSPECIFIED = 0;
  TOGGLE_STATUS_ENABLED = 1;
  TOGGLE_STATUS_DISABLED = 2;
}

// ReadingStatus фиксирует состояние чтения книги.
enum ReadingStatus {
  READING_STATUS_UNSPECIFIED = 0;
  READING_STATUS_READING = 1;
  READING_STATUS_PAUSED = 2;
  READING_STATUS_FINISHED = 3;
}

// BookFavoritedEvent публикуется при добавлении/удалении книги из избранного.
message BookFavoritedEvent {
  string event_id = 1;
  string user_id = 2;
  string book_id = 3;
  ToggleStatus status = 4;
  google.protobuf.Timestamp occurred_at = 5;
  string source = 6; // канал, из которого пришло событие (ios/web/...).
}

// AuthorFollowedEvent публикуется при подписке на автора или отписке от него.
message AuthorFollowedEvent {
  string event_id = 1;
  string follower_id = 2;
  string author_id = 3;
  ToggleStatus status = 4;
  google.protobuf.Timestamp occurred_at = 5;
  string source = 6;
}

// ReadingProgressUpdatedEvent описывает изменение прогресса чтения.
message ReadingProgressUpdatedEvent {
  string event_id = 1;
  string user_id = 2;
  string book_id = 3;
  int32 part = 4;
  double progress_percent = 5;
  ReadingStatus status = 6;
  google.protobuf.Timestamp occurred_at = 7;
  string source = 8;
}

// BookOpenedEvent фиксирует факт открытия книги пользователем (для "недавних").
message BookOpenedEvent {
  string event_id = 1;
  string user_id = 2;
  string book_id = 3;
  int32 part = 4;
  string source = 5;
  google.protobuf.Timestamp occurred_at = 6;
}

// BookFinishedEvent публикуется, когда пользователь завершил книгу.
message BookFinishedEvent {
  string event_id = 1;
  string user_id = 2;
  string book_id = 3;
  int32 last_part = 4;          // на какой части завершили (для сериалов).
  double progress_percent = 5;  // обычно 100, но оставили поле для гибкости.
  google.protobuf.Timestamp finished_at = 6;
  string source = 7;
}

// ChapterReleasedEvent публикуется book-service при выходе новой главы/части.
message ChapterReleasedEvent {
  string event_id = 1;
  string book_id = 2;
  string chapter_id = 3;
  int32 chapter_number = 4;
  string title = 5;
  google.protobuf.Timestamp released_at = 6;
}

// BookReleasedEvent публикуется book-service при выпуске новой книги.
message BookReleasedEvent {
  string event_id = 1;
  string book_id = 2;
  string author_id = 3;
  string title = 4;
  google.protobuf.Timestamp released_at = 5;
  repeated LabelInfo labels = 6;
  repeated LabelInfo hidden_labels = 7;
  string synopsis = 8;
}

// BookMetaInfoUpdatedEvent публикуется при обновлении мета-информации книги.
message BookMetaInfoUpdatedEvent {
  string event_id = 1;
  string book_id = 2;
  string meta_info_id = 3;
  string title = 4;
  string synopsis = 5;
  repeated LabelInfo labels = 6;
  repeated LabelInfo hidden_labels = 7;
  google.protobuf.Timestamp created_at = 8;
  google.protobuf.Timestamp updated_at = 9;
  google.protobuf.Timestamp deleted_at = 10;
  double average_rating = 11;
  int32 parts_count = 12;
  int32 reviews_count = 13;
  int32 comments_count = 14;
}

// ReviewCreatedEvent captures creation of a new review on a book.
message ReviewCreatedEvent {
  string event_id = 1;
  string book_id = 2;
  string review_id = 3;
  string user_id = 4;
  int32 rating = 5;
  google.protobuf.Timestamp occurred_at = 6;
  map<string, string> metadata = 7;
}

// ReviewUpdatedEvent captures updates of an existing review.
message ReviewUpdatedEvent {
  string event_id = 1;
  string book_id = 2;
  string review_id = 3;
  string user_id = 4;
  int32 rating = 5;
  google.protobuf.Timestamp occurred_at = 6;
  map<string, string> metadata = 7;
}

// ReviewDeletedEvent captures soft deletion of a review.
message ReviewDeletedEvent {
  string event_id = 1;
  string book_id = 2;
  string review_id = 3;
  string user_id = 4;
  int32 rating = 5;
  google.protobuf.Timestamp occurred_at = 6;
  map<string, string> metadata = 7;
}

// CommentCreatedEvent captures creation of a new comment on a chapter.
message CommentCreatedEvent {
  string event_id = 1;
  string book_id = 2;
  string comment_id = 3;
  string user_id = 4;
  string book_part_id = 5;
  google.protobuf.Timestamp occurred_at = 6;
  map<string, string> metadata = 7;
}

// CommentDeletedEvent captures deletion of an existing comment.
message CommentDeletedEvent {
  string event_id = 1;
  string book_id = 2;
  string comment_id = 3;
  string user_id = 4;
  string book_part_id = 5;
  google.protobuf.Timestamp occurred_at = 6;
  map<string, string> metadata = 7;
}

// LabelType enumerates supported label taxonomies shared across services.
enum LabelType {
  LABEL_TYPE_UNSPECIFIED = 0;
  LABEL_TYPE_GENRE = 1;
  LABEL_TYPE_AGE_RATING = 2;
  LABEL_TYPE_STATUS = 3;
  LABEL_TYPE_LANGUAGE = 4;
  LABEL_TYPE_FORM = 5;
  LABEL_TYPE_USER_CREATED = 6;
}

// LabelInfo represents full label information in events.
message LabelInfo {
  string id = 1;
  int32 type = 2;
  string name = 3;
  string description = 4;
}

// PreferenceSelection describes a chosen label/type pair.
message PreferenceSelection {
  string label_name = 1;
  LabelType label_type = 2;
}

// UserPreferencesUpdatedEvent is emitted when a user updates their explicit preferences.
message UserPreferencesUpdatedEvent {
  string event_id = 1;
  string user_id = 2;
  repeated PreferenceSelection preferences = 3;
  google.protobuf.Timestamp occurred_at = 4;
}

// ============================================================================
// Recommendation Service Events
// ============================================================================

// RecommendationType defines the type of recommendation computed.
enum RecommendationType {
  RECOMMENDATION_TYPE_UNSPECIFIED = 0;
  RECOMMENDATION_TYPE_PERSONALIZED = 1;    // Персональные рекомендации (hybrid)
  RECOMMENDATION_TYPE_CONTENT_BASED = 2;   // На основе контента
  RECOMMENDATION_TYPE_COLLABORATIVE = 3;   // Collaborative filtering
  RECOMMENDATION_TYPE_TRENDING = 4;        // Trending/популярные
  RECOMMENDATION_TYPE_SIMILAR = 5;         // Похожие на книгу
  RECOMMENDATION_TYPE_COLD_START = 6;      // Для новых пользователей
}

// RecommendedBook represents a single book recommendation with score and reason.
message RecommendedBook {
  string book_id = 1;
  double score = 2;
  string reason = 3;                       // "because you liked X", "trending in genre Y"
}

// RecommendationsComputedEvent is published when recommendations are computed for a user.
message RecommendationsComputedEvent {
  string event_id = 1;
  string user_id = 2;
  RecommendationType recommendation_type = 3;
  repeated RecommendedBook books = 4;
  string algorithm = 5;                    // Algorithm version used
  google.protobuf.Timestamp computed_at = 6;
  google.protobuf.Timestamp expires_at = 7;
}

// TrendingComputedEvent is published when global trending list is updated.
message TrendingComputedEvent {
  string event_id = 1;
  string period = 2;                       // daily/weekly/monthly
  repeated RecommendedBook books = 3;
  google.protobuf.Timestamp computed_at = 4;
}

// SimilarBooksComputedEvent is published when similar books for a book are computed.
message SimilarBooksComputedEvent {
  string event_id = 1;
  string book_id = 2;
  repeated RecommendedBook similar_books = 3;
  string algorithm = 4;
  google.protobuf.Timestamp computed_at = 5;
}

// ============================================================================
// Home Feed Service Events
// ============================================================================

// ShelfType defines the type of shelf on the home feed.
enum ShelfType {
  SHELF_TYPE_UNSPECIFIED = 0;
  SHELF_TYPE_CONTINUE_READING = 1;         // Продолжить чтение
  SHELF_TYPE_FOR_YOU = 2;                  // Для вас (персональные)
  SHELF_TYPE_TRENDING = 3;                 // Популярное сейчас
  SHELF_TYPE_NEW_FROM_AUTHORS = 4;         // Новое от авторов
  SHELF_TYPE_NEW_CHAPTERS = 5;             // Новые главы
  SHELF_TYPE_RECENTLY_ADDED = 6;           // Недавно добавленные
  SHELF_TYPE_BECAUSE_YOU_READ = 7;         // Потому что вы читали X
  SHELF_TYPE_TOP_RATED = 8;                // Лучшие по оценкам
}

// ShelfItem represents a single item in a shelf.
message ShelfItem {
  string book_id = 1;
  double score = 2;
  string reason = 3;
  map<string, string> metadata = 4;        // Additional display data
  google.protobuf.Timestamp added_at = 5;
}

// ShelfUpdatedEvent is published when a user's shelf is updated.
message ShelfUpdatedEvent {
  string event_id = 1;
  string user_id = 2;                      // Empty for global shelves
  ShelfType shelf_type = 3;
  repeated ShelfItem items = 4;
  int32 version = 5;
  google.protobuf.Timestamp updated_at = 6;
}

// ShelfInvalidatedEvent signals that a shelf needs to be rebuilt.
message ShelfInvalidatedEvent {
  string event_id = 1;
  string user_id = 2;                      // Empty for global shelves
  ShelfType shelf_type = 3;
  string reason = 4;
  google.protobuf.Timestamp occurred_at = 5;
}
